<!-- 
	By Zach Zager, Jinglei Zuo, and Ke "Coco" Lan
	Last Edited: April 24, 2018
-->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>Top US Universities</title>
</head>
<style>

body {
	background: #eee;
}

h1 {
  padding-left: 40px;
  margin-bottom: -10px;
}

.content {
	width: 100%;
}

.credits {
  padding-left: 40px;
  margin-top:20px;
  margin-bottom: 10px;
}

.description {
  padding-left: 40px;
  margin-top:20px;
  margin-bottom: 10px;
}

.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
  cursor: pointer;
}

.float-left {
	float: left;
}

#legend {
	width: 225px;
	padding-left: 40px;
}

@media screen and (min-width: 1150px) {
    .map-and-legend {
    	float: left;
    }
    .charts-section {
    	height: 600px;
    	overflow: scroll;
    	float: right
    }
}

@media screen and (max-width: 1149px) {
    .map-and-legend {
		margin: auto;
    }
	.chart {
		float: left;
	}
}

@media screen and (max-width: 1015px) {
	.charts-section {
		text-align: center;
	}
	.chart {
		float: none;
	}
}

.chart-title {
	font-size: 20px;
	margin-bottom: 5px;
}

.bar { 
	fill: steelblue;
	font-size:12px;
	cursor: pointer;
}

.graph {
    margin: 10px 0px 10px 0px;
}

.map-and-legend {
	width: 600px;
	height: 450px;
    padding-left: 30px;
}

.maplegend {
	height: 60px;
    width: 150px;
    float:left;
    text-align: center;
}
.maplegend-info {
	margin: 0px 0px 0px 5px;
}
#maplegend-color {
	background-image: linear-gradient(90deg, rgb(135, 255, 233) 0%, rgb(0, 0, 255) 100%);
	height: 30px;
    width: 95px;
    display: inline-block;
    vertical-align: center;
}
.maplegend-label {
	margin: 0px 5px 0px 5px;
	display: inline-block;
}

.text {
	font-family: 'Open Sans',Arial, Tahoma, sans-serif;
}

.tooltip-title {
	font-weight: bold;
	font-size: 15px;
}

.tooltip-subtitle {
	margin-bottom: 5px;
}
.center {
	text-align: center;
}

.tick {
	font-size: 12px;
}

.thumbnail {
    display: block;
    margin: auto;
    margin-top: 5px;
    margin-bottom: 5px;
    width: 80%;
}

</style>
<h1 class='title text'></h1>
<div class='text description'></div>
<div class='credits text'></div>
<div class='content'>
	<div class='map-and-legend'>
		<svg class='float-left cursor map' width="600" height="390"></svg>
		<div class='maplegend text'>
			<div id='maplegend-label'>Number of Schools</div>
			<div class='maplegend-info'><div class='maplegend-label'>1</div><div id='maplegend-color'></div><div class='maplegend-label'>27</div></div>
		</div>
	</div>
	<div class='charts-section'>
		<div class='chart'>
			<div id='acceptance-title' class='chart-title text'></div><svg class='cursor graph acceptance' width="500" height="350"></svg>
		</div>
		<div class='chart'>
			<div id='scores-title' class='chart-title text'></div><svg class='cursor graph testScores' width="500" height="350"></svg>
		</div>
		<div class='chart'>
			<div id='tuition-title' class='chart-title text'></div><svg class='cursor graph tuition' width="500" height="350"></svg>
		</div>
		<div class='chart'>
			<div id='enrollment-title' class='chart-title text'></div><svg class='cursor graph enrollment' width="500" height="350"></svg>
		</div>
	</div>
</div>

<script src="js/d3.v4.min.js"></script>
<script src="js/topojson.v2.min.js"></script>
<script>

let userChoice = 'USA Top 30';

function setGraphTitles() {
	let scores_title = d3.select("#scores-title").html("Average ACT Scores: "+userChoice);
	let tuition_title = d3.select("#tuition-title").text("Average Annual Tuition: "+userChoice);
	let acceptance_title = d3.select("#acceptance-title").text("Acceptance Rate: "+userChoice);
	let students_title = d3.select("#enrollment-title").text("Number of Students: "+userChoice);
}

let title = d3.select("h1.title").text("Top Universities in the USA");
let subtitle = d3.select(".description").html("This tool is designed to help you choose schools to attend in the United States based on data from 2018. Select a state to view the top schools ranked by several categories. By default, the charts show the top 30 schools based on US News' annual rankings. Place your cursor over the bars on the graphs for more information about individual schools. It should be noted that this tool does not include America's many colleges that do not have university status.");
let credits = d3.select(".credits").html("<div>April 24, 2018 // <a href='https://zachzager.wixsite.com/portfolio'>Zach Zager</a>, <a href='https://www.linkedin.com/in/jingleizuo/'>Jinglei Zuo</a>, and <a href='https://www.linkedin.com/in/%E5%8F%AF-%E5%85%B0-a4247a142/'>Ke \"Coco\" Lan</a></div>");
setGraphTitles();

let map = d3.select("svg.map"),
    map_width = +map.attr("width"),
    map_height = +map.attr("height");

let margin = {top: -20, right: 20, bottom: 30, left: 220};

let testScores_frame = d3.select("svg.testScores");
let testScores = testScores_frame.append('g')
	.attr("transform", "translate(" + margin.left + ",0)");

let graph_width = +testScores_frame.attr("width")-20,
	graph_height = +testScores_frame.attr("height")-40;

let tuition_frame = d3.select("svg.tuition");
let tuition = tuition_frame.append('g')
	.attr("transform", "translate(" + margin.left + ",0)");

let acceptance_frame = d3.select("svg.acceptance");
let acceptance = acceptance_frame.append('g')
	.attr("transform", "translate(" + margin.left + ",0)");

let enrollment_frame = d3.select("svg.enrollment");
let enrollment = enrollment_frame.append('g')
	.attr("transform", "translate(" + margin.left + ",0)");

var rateByState = d3.map(); // map data by FIPS

var projection = d3.geoAlbersUsa()
    .scale(800)
    .translate([map_width / 2, map_height / 2]);

var path = d3.geoPath().projection(projection);

d3.queue()
    .defer(d3.json, "js/us.json")
    .defer(d3.json, "js/schoolInfo.json")
    .await(ready);

let stateCountList = {};
// returns tallied list of how many schools are in each state
function tallyStates(d) {
	let stateList = {};
	let maxCount = 0;
	for (let i = 0; i < d.length; i++) {
		if (d[i].state in stateList) {
			stateList[d[i].state]++;

			// keep track of highest school count
			if (stateList[d[i].state] > maxCount){
				maxCount = stateList[d[i].state];
			}
		} else {
			stateList[d[i].state] = 1;
		}
	}
	stateCountList = stateList;

	// store values in rateByState, converting state names to state codes
	for (state in stateList) {
		rateByState.set(stateCodes[state],stateList[state]);
	}
	return maxCount;
}

// tooltip
// initializes tooltip for all charts and maps
let tooltip = d3.select("body")
	.append("div")
	.style('background-color','#d0d4db')
	.style('border','solid 0.5px')
	.style('border-radius','5px')
	.style('padding','10px 10px 10px 10px')
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden")
	.style('font-size', '12px')
	.style('font-family', 'Open Sans');

function ready(error, us, schools) {
  	if (error) throw error;

  	// draw various graphical elements
  	drawMap(us,schools);
  	drawCharts(schools);
}

// call chart drawing functions with optional single state parameter
function drawCharts(schools,state="") {
	// console.log(schools);
	setChoice(state);

	// choose data from selected state
	if (state !== "") {
		let tempList = [];
		for (items in schools) {
			if (schools[items]['state'] === state) {
				tempList.push(schools[items]);
			}
		}
		schools = tempList;
	} else {
		schools = getTop30(schools);
	}

  	drawScores(schools,state);
  	drawTuition(schools,state);
  	drawAcceptance(schools,state);
  	drawEnrollment(schools,state);
}

function setChoice(state="") {
	if (state === "") {
		userChoice = 'USA Top 30';
	} else {
		userChoice = stateCodesToName[stateCodes[state]];
	}
	setGraphTitles();
}

// scaled color of prev state for viz
let selectedStateFill;

// draws map on page
function drawMap(us,schools){
  	let maxCount = tallyStates(schools);
  	let color = d3.scaleLinear().domain([1,maxCount])
    	.interpolate(d3.interpolateHcl)
    	.range([d3.rgb('#87ffe9'), d3.rgb('#0000ff')]);

	// add states to map w/ data
	// mouse events handle county name+state tooltip
  	map.append("g")
	    .attr("class", "states")
	    .selectAll("path")
	    .data(topojson.feature(us, us.objects.states).features)
	    .enter().append("path")
	    	.attr('style', (d)=> { return 'fill: ' + color(rateByState.get(d.id)); })
	    	.attr('id',(d)=>{ return stateCodesRev[d.id]; })
	    	.attr("d", path)
	    .on("mouseover", (d)=>{ 
	    	tooltip.html("<div class='tooltip-title center'>"+stateCodesToName[d.id]+"</div><div class='center'>"+stateCountList[stateCodesRev[d.id]]+" school(s)</div>");
	    	tooltip.style("visibility", "visible");
	    })
	    .on("mousemove", (d)=>{ tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
		.on("mouseout", (d)=>{ tooltip.style("visibility", "hidden"); })
		.on("click", selectState);

		// handles user selecting (clicking) a state on the map
		// if state has already been selected it will deselect
		function selectState(d) {
			let clickedState = d3.select('#'+stateCodesRev[d.id])
			let prevState = d3.select('.selected');
			// checks if state has already been selected
			if (clickedState.attr('class') === 'selected') {
				prevState.classed('selected',false);
				prevState.style('fill',selectedStateFill);
				drawCharts(schools);
			} else {
				prevState.classed('selected',false);
				prevState.style('fill', selectedStateFill);
				clickedState.classed('selected',true);
				selectedStateFill = clickedState.style('fill');
				clickedState.style('fill','red');
				drawCharts(schools,stateCodesRev[d.id])
			}
		}
}

// returns list of top 30 schools by overall rank
function getTop30(schools) {
	let tempList = [];
	for (items in schools) {
		if (+schools[items]['overallRank'] < 31 && +schools[items]['overallRank'] > 0) {
			tempList.push(schools[items]);
		}
	}
	return tempList;
}

//
// Callback functions for generating graph tool tips
//
function graphMouseOver(d) {
	// format cost after aid
	let cost_after_aid = "";
	if (d['cost-after-aid'] == null) {
		cost_after_aid = "";
	} else {
		cost_after_aid = " ($"+d['cost-after-aid']+" after aid)";
	}

	tooltip.html("<div class='tooltip-title center'>"+d['displayName']+"</div>\
		<div class='tooltip-subtitle center'>"+d['city']+', '+d['state']+'</div>\
		<div>Average ACT Score: '+d['act-avg']+'</div>\
		<div>Enrollment: '+d['enrollment']+"</div>\
		<div>Tuition: $"+d['tuition']+cost_after_aid+"</div>\
		<div>Acceptance Rate: "+d['acceptance-rate']+"%</div>\
		<img class='thumbnail' src="+d['primaryPhotoThumb']+" />\
		<div class='center'>Click to search for this school</div>");
	tooltip.style("visibility", "visible");
	tooltip.append('hi');
}
function graphMouseMove(d) { tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"); }
function graphMouseOut(d) { tooltip.style("visibility", "hidden"); }

// Acceptance Rate
// draw chart of acceptance rate
function drawAcceptance(schools,state) {
	schools.sort( (a,b)=>{ return b['acceptance-rate']-a['acceptance-rate']; }); // sort items
	acceptance.selectAll("*").remove(); // remove previous chart

	// set the ranges
	let x = d3.scaleLinear().range([0, graph_width-margin.left]);
	let y = d3.scaleBand().range([graph_height, 0]);

	// Scale the range of the data in the domains
	x.domain([0, d3.max(schools, (d)=> { return d['acceptance-rate']; })]);
	y.domain(schools.map((d)=> { return d['displayName']; })).padding(0.1);

    acceptance.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(y))
        .selectAll('.y-axis');

	acceptance.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + graph_height + ")")
      	.call(d3.axisBottom(x).ticks(5).tickFormat((d)=> { return +d+"%"; }).tickSizeInner([-graph_height]));

    acceptance.selectAll(".bar")
        .data(schools)
   		.enter().append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", (d)=> { return y(d['displayName']); })
        .attr("width", (d)=> { return x(d['acceptance-rate']); })
	    .on("mouseover", graphMouseOver)
	    .on("mousemove", graphMouseMove)
		.on("mouseout", graphMouseOut)
		.on('click', (d)=> { window.open('http://www.google.com/search?q='+d['displayName']); });


	// text label for the x axis
	acceptance.append("text")             
		.attr("transform", "translate(" + ((graph_width-margin.left)/2) + " ," + (graph_height + margin.top + 50) + ")")
    	.style("text-anchor", "middle")
    	.attr('class','text')
    	.text("Acceptance Rate");
}

// Average ACT Score
// draw chart of average ACT test scores
function drawScores(schools,state) {
	schools.sort( (a,b)=>{ return a['act-avg']-b['act-avg']; }); // sort items

	testScores.selectAll("*").remove(); // remove previous chart

	// set the ranges
	let x = d3.scaleLinear().range([0, graph_width-margin.left]);
	let y = d3.scaleBand().range([graph_height, 0]);

	// Scale the range of the data in the domains
	x.domain([0, d3.max(schools, (d)=> { return d['act-avg']; })]);
	y.domain(schools.map((d)=> { return d['displayName']; })).padding(0.1);

    testScores.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(y))
        .selectAll('.y-axis');

	testScores.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + graph_height + ")")
      	.call(d3.axisBottom(x).ticks(5).tickFormat((d)=> { return +d; }).tickSizeInner([-graph_height]));

    testScores.selectAll(".bar")
        .data(schools)
   		.enter().append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", (d)=> { return y(d['displayName']); })
        .attr("width", (d)=> { return x(d['act-avg']); })
	    .on("mouseover", graphMouseOver)
	    .on("mousemove", graphMouseMove)
		.on("mouseout", graphMouseOut)
		.on('click', (d)=> { window.open('http://www.google.com/search?q='+d['displayName']); });

	// text label for the x axis
	testScores.append("text")             
		.attr("transform", "translate(" + ((graph_width-margin.left)/2) + " ," + (graph_height + margin.top + 50) + ")")
    	.style("text-anchor", "middle")
    	.attr('class','text')
    	.text("Average ACT Score");
}

// Average Annual Tuition
// draw chart of tuition
function drawTuition(schools,state) {
	schools.sort( (a,b)=>{ return a['tuition']-b['tuition']; }); // sort items
	tuition.selectAll("*").remove(); // remove previous chart

	// set the ranges
	let x = d3.scaleLinear().range([0, graph_width-margin.left]);
	let y = d3.scaleBand().range([graph_height, 0]);

	// Scale the range of the data in the domains
	x.domain([0, d3.max(schools, (d)=> { return d['tuition']; })]);
	y.domain(schools.map((d)=> { return d['displayName']; })).padding(0.1);

    tuition.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(y).tickFormat((d)=> { return d; }))
        .selectAll('.y-axis');

	tuition.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + graph_height + ")")
      	.call(d3.axisBottom(x).ticks(5).tickFormat((d)=> { return "$"+d; }).tickSizeInner([-graph_height]));

    tuition.selectAll(".bar")
        .data(schools)
   		.enter().append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", (d)=> { return y(d['displayName']); })
        .attr("width", (d)=> { return x(d['tuition']); })
	    .on("mouseover", graphMouseOver)
	    .on("mousemove", graphMouseMove)
		.on("mouseout", graphMouseOut)
		.on('click', (d)=> { window.open('http://www.google.com/search?q='+d['displayName']); });

	// text label for the x axis
	tuition.append("text")             
		.attr("transform", "translate(" + ((graph_width-margin.left)/2) + " ," + (graph_height + margin.top + 50) + ")")
    	.style("text-anchor", "middle")
    	.attr('class','text')
    	.text("Annual Tuition Before Aid");
}

// Number of students
// draw chart of enrollment
function drawEnrollment(schools,state) {

	schools.sort( (a,b)=>{ return a['enrollment']-b['enrollment']; }); // sort items
	enrollment.selectAll("*").remove(); // remove previous chart

	// set the ranges
	let x = d3.scaleLinear().range([0, graph_width-margin.left]);
	let y = d3.scaleBand().range([graph_height, 0]);

	// Scale the range of the data in the domains
	x.domain([0, d3.max(schools, (d)=> { return d['enrollment']; })]);
	y.domain(schools.map((d)=> { return d['displayName']; })).padding(0.1);

    enrollment.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(y).tickFormat((d)=> { return d; }))
        .selectAll('.y-axis');

	enrollment.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + graph_height + ")")
      	.call(d3.axisBottom(x).ticks(5).tickFormat((d)=> { return d; }).tickSizeInner([-graph_height]));

    enrollment.selectAll(".bar")
        .data(schools)
   		.enter().append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", (d)=> { return y(d['displayName']); })
        .attr("width", (d)=> { return x(d['enrollment']); })
	    .on("mouseover", graphMouseOver)
	    .on("mousemove", graphMouseMove)
		.on("mouseout", graphMouseOut)
		.on('click', (d)=> { window.open('http://www.google.com/search?q='+d['displayName']); });

	// text label for the x axis
	enrollment.append("text")             
		.attr("transform", "translate(" + ((graph_width-margin.left)/2) + " ," + (graph_height + margin.top + 50) + ")")
    	.style("text-anchor", "middle")
    	.attr('class','text')
    	.text("Number of Enrolled Students");
}

// state abbreviations (keys), id numbers (values)
let stateCodes = {
	'AL': 1, 'AK': 2, 'AZ': 4, 'AR': 5, 'CA': 6, 'CO': 8, 'CT': 9, 'DE': 10, 'DC': 11,
	'FL': 12, 'GA': 13, 'HI': 15, 'ID': 16, 'IL': 17, 'IN': 18, 'IA': 19, 'KS': 20,
	'KY': 21, 'LA': 22, 'ME': 23, 'MD': 24, 'MA': 25, 'MI': 26, 'MN': 27, 'MS': 28, 
	'MO': 29, 'MT': 30, 'NE': 31, 'NV': 32, 'NH': 33, 'NJ': 34, 'NM': 35, 'NY': 36, 
	'NC': 37, 'ND': 38, 'OH': 39, 'OK': 40, 'OR': 41, 'PA': 42, 'RI': 44, 'SC': 45, 
	'SD': 46, 'TN': 47, 'TX': 48, 'UT': 49, 'VT': 50, 'VA': 51, 'WA': 53, 'WV': 54, 
	'WI': 55, 'WY': 56
}

// id numbers (keys), state abbreviations (values)
let stateCodesRev = {
	1: 'AL', 2: 'AK', 4: 'AZ', 5: 'AR', 6: 'CA', 8: 'CO', 9: 'CT', 10: 'DE', 11: 'DC',
	12: 'FL', 13: 'GA', 15: 'HI', 16: 'ID', 17: 'IL', 18: 'IN', 19: 'IA', 20: 'KS',
	21: 'KY', 22: 'LA', 23: 'ME', 24: 'MD', 25: 'MA', 26: 'MI', 27: 'MN', 28: 'MS',
	29: 'MO', 30: 'MT', 31: 'NE', 32: 'NV', 33: 'NH', 34: 'NJ', 35: 'NM', 36: 'NY',
	37: 'NC', 38: 'ND', 39: 'OH', 40: 'OK', 41: 'OR', 42: 'PA', 44: 'RI', 45: 'SC',
	46: 'SD', 47: 'TN', 48: 'TX', 49: 'UT', 50: 'VT', 51: 'VA', 53: 'WA', 54: 'WV',
	55: 'WI', 56: 'WY'
}

// id numbers (keys), state name (values)
let stateCodesToName = {
	1: 'Alabama', 2: 'Alaska', 4: 'Arizona', 5: 'Arkansas', 6: 'California', 8: 'Colorado',
	9: 'Connecticut', 10: 'Delaware', 11: 'Washington, DC', 12: 'Florida', 13: 'Georgia',
	15: 'Hawaii', 16: 'Idaho', 17: 'Illinois', 18: 'Indiana', 19: 'Iowa', 20: 'Kansas',
	21: 'Kentucky', 22: 'Louisiana', 23: 'Maine', 24: 'Maryland', 25: 'Massachusetts',
	26: 'Michigan', 27: 'Minnesota', 28: 'Mississippi', 29: 'Missouri', 30: 'Montana',
	31: 'Nebraska', 32: 'Nevada', 33: 'New Hampshire', 34: 'New Jersey', 35: 'New Mexico',
	36: 'New York', 37: 'North Carolina', 38: 'North Dakota', 39: 'Ohio', 40: 'Oklahoma',
	41: 'Oregon', 42: 'Pennsylvania', 44: 'Rhode Island', 45: 'South Carolina',
	46: 'South Dakota', 47: 'Tennessee', 48: 'Texas', 49: 'Utah', 50: 'Vermont',
	51: 'Virginia', 53: 'Washington', 54: 'West Virginia', 55: 'Wisconsin', 56: 'Wyoming'
}

</script>








